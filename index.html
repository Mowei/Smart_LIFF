<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>魚塭管理 - LIFF</title>
    <script src="https://d.line-scdn.net/liff/1.0/sdk.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!--Button-->
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.4.0/css/bootstrap4-toggle.min.css" rel="stylesheet">  
    <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.4.0/js/bootstrap4-toggle.min.js"></script>
    <style>
    .row {
        margin:5px;
    }
    </style>
    <script>
        var client;
        var userName = "User1";
        var subscribeName ="MOWEI/FISH";
        var destinationName ="MOWEI/FISH";
        var readPump5 = "715180 pin5 read";
        var readPump6 = "715180 pin6 read";

        var LogsQueue = {
            Logs : new Array(),
            QueueMax : 10,        
            AddLog : function(msg){
                let count = this.Logs.unshift(msg);
                if(count > this.QueueMax){
                    this.Logs.pop();
                }
                this.ShowLogs();
            },
            ShowLogs : function(){
                let allmsg ="";
                this.Logs.forEach(msg => {
                    allmsg += msg + "<br>";
                });
                $('#messageLog').html(allmsg);
            }
        };

        //init MQTT
        function initializeMQTT(data) {
            //GET userID
            let userId = data.context.userId;
            let acc ="";
            let pass ="";
            
            //取得QueryString
            let urlParams = new URLSearchParams(window.location.search);
            let regexp = /^pumpid=(.*)&pass=(.*)$/g;
            let getuser = regexp.exec(urlParams.toString());
            if(getuser){
                acc=getuser[1];
                pass=getuser[2];
            }else{
                acc=userId.substr(0,8);
                pass=userId.substr(-8,8);
            }
            // Create a client instance
            client = new Paho.MQTT.Client("m12.cloudmqtt.com", 35953,acc);

            // set callback handlers
            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            var options = {
                useSSL: true,
                userName: acc,
                password: pass,
                onSuccess:onConnect,
                onFailure:doFail
            }

            // connect the client
            client.connect(options);

            // called when the client connects
            function onConnect() {
                // Once a connection has been made, make a subscription and send a message.
                console.log("onConnect");
                client.subscribe(subscribeName);
                message = new Paho.MQTT.Message("Hello "+userName+" Join CloudMQTT");
                message.destinationName = "MOWEI/FISH";
                client.send(message);
            }

            function doFail(e){
                console.log(e);
            }

            // called when the client loses its connection
            function onConnectionLost(responseObject) {
                if (responseObject.errorCode !== 0) {
                    let msg ="onConnectionLost:"+responseObject.errorMessage;
                    LogsQueue.AddLog(msg);
                }
            }

            // called when a message arrives
            function onMessageArrived(message) {
                let msg ="onMessageArrived:"+message.payloadString;
                LogsQueue.AddLog(msg);

                //PIN5 READ 0 OK
                let regexp = /^PIN(\d) READ (\d) OK$/g;
                let getMsg = regexp.exec(message.payloadString);
                if(getMsg){
                    let PumpNum = getMsg[1];
                    let PumpOnOff = getMsg[2];
                    $("#pump"+PumpNum).bootstrapToggle(PumpOnOff=="0"?"off":"on");
                    console.log(PumpNum +","+ PumpOnOff);
                }
            }
        }

        function MQTTSend(Message,Destination) {
            message = new Paho.MQTT.Message(Message);
            message.destinationName = Destination;
            client.send(message);
        }

        function getPumpStatus() {
            MQTTSend(readPump5,destinationName);
            MQTTSend(readPump6,destinationName);
        }
        //ready
        $(function () {
            //Init TEST
            //initializeMQTT({context:{userId:"user"}});
            
            //init LIFF            
            liff.init(function (data) {
                liff.getProfile().then(
                    profile=> {
                        userName = profile.displayName;
                        $("#userName").html(userName);
                    }
                );
                initializeMQTT(data);
            });
            
            //ReloadStatus
            $('#ButtonReloadStatus').click(function () {
                getPumpStatus();
            });

            //SendMsg
            $('#ButtonSendMsg').click(function () {
                MQTTSend($("#mqttMsg").val(),destinationName);
            });
            
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="row" >
            <div class="col">
                <div id="userName" style="float: left;"></div>
                <button class="btn btn-primary" id="ButtonReloadStatus" style="float: right;" >Reload</button>
            </div>
        </div>
        <div class="row" >
            <div class="col">
                <div class="border border-success rounded">
                    <label>水車一</label>
                    <input id="pump5" type="checkbox" data-toggle="toggle">
                </div>
            </div>
            <div class="col">
                <div class="border border-success rounded">
                    <label>水車二</label>
                    <input id="pump6" type="checkbox" data-toggle="toggle">
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div class="input-group">
                    <input id="mqttMsg" type="text" class="form-control" value="whoami" />
                    <div class="input-group-append">
                        <button id="ButtonSendMsg" class="btn btn-primary" type="button">傳送</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <label>訊息:</label>
                <div class="border border-primary rounded">
                    <div id="messageLog" style="margin-left:3px"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
